<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>üîí Smart Lock ‚Äì ESP32 MQTT Dashboard</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
      :root {
        --primary: #2196f3;
        --primary-2: #1976d2;
        --accent: #64b5f6;
        --ok: #00c853;
        --warn: #ffd600;
        --err: #d50000;
        --bg: #f5f7fb;
        --card: #ffffff;
        --text: #0b1b2b;
        --muted: #6b7a90;
        --shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        --radius: 14px;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: linear-gradient(180deg, #f7fbff 0%, #eef5fd 100%);
        color: var(--text);
      }
      header {
        background: linear-gradient(90deg, var(--primary-2), var(--accent));
        color: #fff;
        padding: 18px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 5;
      }
      header h1 { margin: 0; font-size: 18px; font-weight: 700; }
      header .sub { font-size: 12px; opacity: 0.9; }
      .container { max-width: 1100px; margin: 20px auto; padding: 0 16px 40px; }
      .grid { display: grid; gap: 16px; }
      .g-3 { grid-template-columns: repeat(3, 1fr); }
      @media (max-width: 900px) { .g-3 { grid-template-columns: 1fr 1fr; } }
      @media (max-width: 640px) { .g-3 { grid-template-columns: 1fr; } }
      .card {
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px;
      }
      .section-title {
        font-size: 14px; font-weight: 700; color: var(--primary-2); margin: 0 0 12px;
      }
      .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      .pill {
        padding: 8px 12px; border-radius: 999px; font-size: 12px; font-weight: 600;
        background: #eef4ff; color: var(--primary-2); border: 1px solid #e2ecff;
      }
      .status-badge {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 10px 14px; border-radius: 12px;
        font-size: 14px; font-weight: 700; color: #fff;
        box-shadow: var(--shadow);
      }
      .status-ok { background: linear-gradient(90deg, #00c853, #00e676); }
      .status-warn { background: linear-gradient(90deg, #ffab00, #ffd600); color: #2b2100; }
      .status-err { background: linear-gradient(90deg, #d50000, #ff1744); }
      .dot { width: 10px; height: 10px; border-radius: 50%; background: #fff; opacity: 0.9; }
      .controls .btn {
        appearance: none; border: none; background: var(--primary); color: #fff;
        font-weight: 700; padding: 10px 14px; border-radius: 10px; cursor: pointer;
        box-shadow: var(--shadow); transition: transform 0.06s ease;
      }
      .controls .btn:hover { transform: translateY(-1px); }
      .btn.secondary {
        background: #fff; color: var(--primary-2); border: 1px solid #d7e5ff;
      }
      table { width: 100%; border-collapse: collapse; font-size: 13px; }
      th, td { padding: 10px 8px; border-bottom: 1px solid #eef2f9; text-align: left; }
      th { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.4px; }
      .tag { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; }
      .tag.ok { background: #e8f7ee; color: #0a7d3a; }
      .tag.err { background: #ffebee; color: #b71c1c; }
      .tag.warn { background: #fff8e1; color: #8d6e00; }
      .muted { color: var(--muted); }
      .toast-wrap {
        position: fixed; right: 16px; top: 16px; display: flex; flex-direction: column;
        gap: 10px; z-index: 10;
      }
      .toast {
        min-width: 260px; background: #fff; border-left: 6px solid var(--primary);
        box-shadow: var(--shadow); border-radius: 10px; padding: 12px 14px;
        animation: slideIn 0.18s ease;
      }
      .toast.ok { border-color: var(--ok); }
      .toast.err { border-color: var(--err); }
      .toast.warn { border-color: var(--warn); }
      @keyframes slideIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>

  <body>
    <header>
      <div>
        <h1>üîí H·ªá th·ªëng kh√≥a b·∫£o m·∫≠t IoT</h1>
        <div class="sub">ESP32 ‚Ä¢ Keypad ‚Ä¢ Servo ‚Ä¢ LED ‚Ä¢ Buzzer ‚Ä¢
          MQTT/WebSocket</div>
      </div>
      <div class="row"><span id="conn-badge" class="pill">MQTT:
          Disconnected</span></div>
    </header>

    <div class="container">
      <div class="grid g-3">
        <div class="card">
          <h3 class="section-title">Tr·∫°ng th√°i hi·ªán t·∫°i</h3>
          <div id="statusBadge" class="status-badge status-warn">
            <span class="dot"></span><span id="statusText">ƒêang ch·ªù d·ªØ
              li·ªáu‚Ä¶</span>
          </div>
          <div class="row" style="margin-top:12px">
            <div><b>‚úÖ H·ª£p l·ªá:</b> <span id="kOk">0</span></div>
            <div><b>‚ö†Ô∏è Sai m·∫≠t kh·∫©u:</b> <span id="kWrong">0</span></div>
            <div><b>üö® B√°o ƒë·ªông:</b> <span id="kAlert">0</span></div>
          </div>
        </div>

        <div class="card">
          <h3 class="section-title">ƒêi·ªÅu khi·ªÉn t·ª´ xa</h3>
          <div class="row controls">
            <button class="btn" data-cmd="LOCK">üîê Kh√≥a</button>
            <button class="btn" data-cmd="UNLOCK">üîì M·ªü</button>
            <button class="btn secondary" data-cmd="SIREN">üö® B·∫≠t c√≤i</button>
          </div>
        </div>

        <div class="card">
          <h3 class="section-title">√Çm b√°o</h3>
          <div class="row controls">
            <button class="btn secondary" id="test-ok">Test "b√≠p" OK</button>
            <button class="btn secondary" id="test-warn">Test "b√≠p" sai</button>
            <button class="btn secondary" id="test-alert">Test c√≤i d√†i</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 class="section-title">L·ªãch s·ª≠ s·ª± ki·ªán</h3>
        <table>
          <thead><tr><th>Th·ªùi gian</th><th>S·ª± ki·ªán</th><th>Chi
                ti·∫øt</th><th>Lo·∫°i</th></tr></thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </div>

    <div class="toast-wrap" id="toasts"></div>

    <script>
      
      ip='172.17.66.131'
      const broker = `ws://${ip}:9001/mqtt`;
      const topicSub = "demo/door/status";
      const topicPub = "demo/door/command";

      // Audio test
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const audioCtx = new AudioCtx();
      document.addEventListener("click", () => {
        if (audioCtx.state === "suspended") audioCtx.resume();
      }, { once: true });

      const beep = (f, d) => {
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.frequency.value = f; g.gain.value = 0.05;
        o.connect(g).connect(audioCtx.destination);
        o.start(); setTimeout(()=>o.stop(), d);
      };
      const chirpOK = ()=>{ beep(1200,100); setTimeout(()=>beep(1500,100),90); };
      const chirpWrong = ()=>{ beep(300,120); setTimeout(()=>beep(260,120),120); };
      const siren = (ms=2000)=>{
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        g.gain.value=0.05; o.type="sawtooth"; o.connect(g).connect(audioCtx.destination);
        o.start(); const start=audioCtx.currentTime;
        const loop=()=>{ const t=audioCtx.currentTime-start, f=600+400*Math.sin(2*Math.PI*t*2);
          o.frequency.setValueAtTime(f,audioCtx.currentTime);
          if(t<ms/1000)requestAnimationFrame(loop); else o.stop(); }; loop();
      };

      const $ = id => document.getElementById(id);
      const logBody = $("logBody"), kOk=$("kOk"), kWrong=$("kWrong"), kAlert=$("kAlert");
      const statusText=$("statusText"), statusBadge=$("statusBadge"), toasts=$("toasts");
      const connBadge=$("conn-badge");

      let okCount=0, wrongCount=0, alertCount=0;
      const toast=(t,m,type="ok",time=4000)=>{
        const el=document.createElement("div");
        el.className=`toast ${type}`; el.innerHTML=`<h4>${t}</h4><p>${m}</p>`;
        toasts.appendChild(el); setTimeout(()=>{el.style.opacity=0;setTimeout(()=>el.remove(),300)},time);
      };
      const addLog=(ev,detail,type)=>{
        const tr=document.createElement("tr");
        const now=new Date().toLocaleString();
        tr.innerHTML=`<td>${now}</td><td>${ev}</td><td class="muted">${detail||""}</td>
          <td>${type==="ok"?"<span class='tag ok'>OK</span>":type==="err"?"<span class='tag err'>ERR</span>":"<span class='tag warn'>WARN</span>"}</td>`;
        logBody.prepend(tr);
      };
      const setStatus=(type,txt)=>{
        statusBadge.className="status-badge "+(type==="ok"?"status-ok":type==="err"?"status-err":"status-warn");
        statusText.textContent=txt;
      };

      // MQTT
      const client=mqtt.connect(broker,{clientId:"web-"+Math.random().toString(16).slice(2)});
      client.on("connect",()=>{
        connBadge.textContent="üü¢ MQTT Connected";
        client.subscribe(topicSub);
        toast("K·∫øt n·ªëi MQTT","ƒê√£ k·∫øt n·ªëi "+broker,"ok");
        addLog("Connect",broker,"ok");
      });
      client.on("error",e=>toast("L·ªói MQTT",e.message,"err"));
      client.on("close",()=>connBadge.textContent="‚ö™ Disconnected");

      client.on("message",(t,p)=>{
        const msg=p.toString().trim();
        if(msg==="UNLOCKED"){ okCount++; kOk.textContent=okCount; setStatus("ok","C·ª≠a M·ªû"); chirpOK(); toast("‚úÖ M·ªü c·ª≠a","Access granted","ok"); addLog("Door unlocked","UNLOCKED","ok"); }
        else if(msg==="LOCKED"){ setStatus("warn","C·ª≠a ƒê√ìNG"); addLog("Door locked","LOCKED","warn"); }
        else if(msg==="WRONG_PASSWORD"){ wrongCount++; kWrong.textContent=wrongCount; setStatus("warn","Sai m·∫≠t kh·∫©u"); chirpWrong(); toast("‚ùå Sai m·∫≠t kh·∫©u","Wrong password","warn"); addLog("Wrong password","WRONG_PASSWORD","warn"); }
        else if(msg==="INTRUSION_ALERT"){ alertCount++; kAlert.textContent=alertCount; setStatus("err","C·∫£nh b√°o x√¢m nh·∫≠p"); siren(2200); toast("üö® B√°o ƒë·ªông","Intrusion alert","err"); addLog("Intrusion","INTRUSION_ALERT","err"); }
      });

      // Buttons
      document.querySelectorAll("[data-cmd]").forEach(b=>b.addEventListener("click",()=>{
        const cmd=b.getAttribute("data-cmd");
        client.publish(topicPub,cmd);
        addLog("Publish",cmd,"ok");
        toast("G·ª≠i l·ªánh",cmd,"ok",2000);
      }));
      $("test-ok").onclick=chirpOK;
      $("test-warn").onclick=chirpWrong;
      $("test-alert").onclick=()=>siren(1500);
    </script>
  </body>
</html>
